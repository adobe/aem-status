<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Cause Analysis - AEM Edge Delivery Status</title>
    <meta name="description" content="Analysis of incident root causes, internal services, and external vendor dependencies">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="styles/styles.css">
    <style>
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spectrum-spacing-600);
            margin-top: var(--spectrum-spacing-600);
        }

        .analysis-section {
            background: white;
            padding: var(--spectrum-spacing-600);
            border-radius: var(--spectrum-border-radius-200);
            box-shadow: var(--spectrum-shadow-200);
        }

        .section-title {
            font-size: var(--spectrum-font-size-xlarge);
            font-weight: 800;
            color: var(--spectrum-gray-900);
            margin-bottom: var(--spectrum-spacing-400);
            border-bottom: 2px solid var(--spectrum-blue-600);
            padding-bottom: var(--spectrum-spacing-200);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--spectrum-spacing-400);
            margin-bottom: var(--spectrum-spacing-600);
        }

        .stat-card {
            background: var(--spectrum-blue-50);
            padding: var(--spectrum-spacing-400);
            border-radius: var(--spectrum-border-radius-200);
            text-align: center;
            border: 2px solid var(--spectrum-blue-200);
        }

        .stat-value {
            font-size: var(--spectrum-font-size-xxlarge);
            font-weight: 800;
            color: var(--spectrum-blue-700);
            margin-bottom: var(--spectrum-spacing-100);
        }

        .stat-label {
            font-size: var(--spectrum-font-size-small);
            color: var(--spectrum-gray-700);
            line-height: 1.4;
        }

        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spectrum-spacing-600);
        }

        .visualization-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 400px;
        }

        .pie-chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .pie-chart {
            width: 100%;
            height: auto;
        }

        .pie-slice {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .pie-slice:hover {
            opacity: 0.8;
            filter: brightness(1.1);
        }

        .legend {
            margin-top: var(--spectrum-spacing-400);
            width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spectrum-spacing-200);
            margin-bottom: var(--spectrum-spacing-200);
            padding: var(--spectrum-spacing-100) var(--spectrum-spacing-200);
            border-radius: var(--spectrum-border-radius-100);
            cursor: pointer;
            transition: background 0.2s;
        }

        .legend-item:hover {
            background: var(--spectrum-gray-100);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: var(--spectrum-border-radius-100);
            flex-shrink: 0;
        }

        .legend-label {
            flex: 1;
            font-size: var(--spectrum-font-size-small);
            color: var(--spectrum-gray-800);
        }

        .legend-value {
            font-weight: 700;
            color: var(--spectrum-gray-900);
            font-size: var(--spectrum-font-size-small);
        }

        .bar-chart {
            width: 100%;
            margin-top: var(--spectrum-spacing-400);
        }

        .bar-item {
            display: flex;
            align-items: center;
            margin-bottom: var(--spectrum-spacing-300);
            gap: var(--spectrum-spacing-200);
        }

        .bar-label {
            width: 120px;
            text-align: right;
            font-size: var(--spectrum-font-size-small);
            color: var(--spectrum-gray-800);
            font-weight: 600;
            flex-shrink: 0;
        }

        .bar-visual {
            flex: 1;
            position: relative;
            height: 32px;
            background: var(--spectrum-gray-100);
            border-radius: var(--spectrum-border-radius-100);
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--spectrum-blue-600);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: var(--spectrum-spacing-300);
            color: white;
            font-size: var(--spectrum-font-size-small);
            font-weight: 700;
            min-width: 30px;
            box-sizing: border-box;
        }

        .bar-fill.vendor {
            background: var(--spectrum-orange-600);
        }

        .matrix-container {
            overflow-x: auto;
            margin-top: var(--spectrum-spacing-400);
        }

        .matrix {
            display: table;
            border-collapse: separate;
            border-spacing: 2px;
            margin: 0 auto;
            font-size: var(--spectrum-font-size-small);
        }

        .matrix-row {
            display: table-row;
        }

        .matrix-cell {
            display: table-cell;
            min-width: 60px;
            height: 40px;
            text-align: center;
            vertical-align: middle;
            border-radius: var(--spectrum-border-radius-100);
            font-weight: 600;
            transition: all 0.2s ease;
            padding: 4px;
        }

        .matrix-cell.header {
            background: transparent;
            font-weight: 800;
            color: var(--spectrum-gray-700);
            border: none;
        }

        .matrix-cell.row-label {
            text-align: right;
            padding-right: var(--spectrum-spacing-300);
            font-weight: 800;
            color: var(--spectrum-gray-700);
            background: transparent;
            min-width: 100px;
        }

        .matrix-cell.data {
            cursor: pointer;
            color: white;
        }

        .matrix-cell.data:hover {
            transform: scale(1.1);
            box-shadow: var(--spectrum-shadow-300);
            z-index: 10;
        }

        .matrix-cell.level-0 { background-color: #f0f0f0; color: var(--spectrum-gray-700); }
        .matrix-cell.level-1 { background-color: #e3f2fd; color: var(--spectrum-gray-900); }
        .matrix-cell.level-2 { background-color: #90caf9; }
        .matrix-cell.level-3 { background-color: #64b5f6; }
        .matrix-cell.level-4 { background-color: #42a5f5; }
        .matrix-cell.level-5 { background-color: #ff9800; }
        .matrix-cell.level-6 { background-color: #ff8f00; }
        .matrix-cell.level-7 { background-color: #ff6f00; }
        .matrix-cell.level-8 { background-color: #e65100; }
        .matrix-cell.level-9 { background-color: #d84315; }
        .matrix-cell.level-10 { background-color: #bf360c; }

        .tooltip {
            position: fixed;
            background: var(--spectrum-gray-900);
            color: white;
            padding: var(--spectrum-spacing-200) var(--spectrum-spacing-300);
            border-radius: var(--spectrum-border-radius-100);
            font-size: var(--spectrum-font-size-small);
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: var(--spectrum-shadow-400);
            max-width: 300px;
        }

        .tooltip.visible {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: var(--spectrum-spacing-600);
            color: var(--spectrum-gray-600);
            font-style: italic;
        }

        @media (max-width: 1024px) {
            .visualization-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .bar-label {
                width: 80px;
                font-size: 11px;
            }

            .matrix-cell {
                min-width: 45px;
                height: 35px;
                font-size: 11px;
            }

            .matrix-cell.row-label {
                min-width: 70px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div>
                <h1>Root Cause Analysis</h1>
                <p>Understanding what causes incidents and system dependencies</p>
            </div>
        </div>
    </header>

    <main class="container">
        <p><a class="back-link" href="/">‚Üê Back to status</a></p>

        <!-- Key Metrics -->
        <section class="section">
            <div class="section-head">
                <h2>Key Metrics</h2>
            </div>
            <div class="stats-grid" id="key-metrics"></div>
        </section>

        <!-- Root Cause Analysis -->
        <section class="section">
            <div class="section-head">
                <h2>Root Cause Distribution</h2>
            </div>
            <div class="analysis-section">
                <div class="visualization-grid">
                    <div class="visualization-container">
                        <h3 class="section-title">By Category</h3>
                        <div class="pie-chart-container">
                            <svg class="pie-chart" id="pie-chart" viewBox="0 0 400 400"></svg>
                        </div>
                    </div>
                    <div class="visualization-container">
                        <h3 class="section-title">Breakdown</h3>
                        <div class="legend" id="cause-legend"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Systems & Vendors -->
        <section class="section">
            <div class="section-head">
                <h2>Systems & Vendors</h2>
            </div>
            <div class="analysis-section">
                <div class="visualization-grid">
                    <div class="visualization-container">
                        <h3 class="section-title">Internal Services</h3>
                        <div class="bar-chart" id="services-chart"></div>
                    </div>
                    <div class="visualization-container">
                        <h3 class="section-title">External Vendors</h3>
                        <div class="bar-chart" id="vendors-chart"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dependency Matrix -->
        <section class="section">
            <div class="section-head">
                <h2>Dependency Matrix</h2>
                <p style="color: var(--spectrum-gray-600); font-size: var(--spectrum-font-size-small); margin-top: var(--spectrum-spacing-200);">
                    Shows co-occurrence of internal services and external vendors in incidents
                </p>
            </div>
            <div class="analysis-section">
                <div class="matrix-container" id="matrix-container"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container copyright">
            Copyright &copy; <span id="year"></span> Adobe. All rights reserved /
            <a href="https://adobe.com/privacy.html">Privacy</a> /
            <a href="https://www.adobe.com/legal/terms.html">Terms of Use</a> /
            <a href="https://www.adobe.com/privacy/ca-rights.html">Do not sell my personal information</a>
        </div>
    </footer>

    <div class="tooltip" id="tooltip"></div>

    <script type="module">
        // Color palette for root causes
        const CAUSE_COLORS = {
            'third-party-outage': '#e63946',
            'configuration-change': '#ff9f1c',
            'deployment-issue': '#ffbf69',
            'unknown': '#9d9d9d',
            'credential-issue': '#a8dadc',
            'resource-limits': '#457b9d',
            'dns-issue': '#1d3557',
            'network-issue': '#2a9d8f',
            'dependency-issue': '#e76f51'
        };

        const CAUSE_LABELS = {
            'third-party-outage': 'Third-party Outage',
            'configuration-change': 'Configuration Change',
            'deployment-issue': 'Deployment Issue',
            'unknown': 'Unknown',
            'credential-issue': 'Credential Issue',
            'resource-limits': 'Resource Limits',
            'dns-issue': 'DNS Issue',
            'network-issue': 'Network Issue',
            'dependency-issue': 'Dependency Issue'
        };

        // Fetch incident data
        const getIncidents = async () => {
            const response = await fetch('/incidents/index.json');
            const incidents = await response.json();
            return incidents;
        };

        // Aggregate root causes
        const aggregateRootCauses = (incidents) => {
            const causes = {};
            incidents.forEach(incident => {
                const cause = incident.rootCause || 'unknown';
                causes[cause] = (causes[cause] || 0) + 1;
            });
            return Object.entries(causes)
                .map(([cause, count]) => ({ cause, count }))
                .sort((a, b) => b.count - a.count);
        };

        // Aggregate internal services
        const aggregateServices = (incidents) => {
            const services = {};
            incidents.forEach(incident => {
                const serviceList = incident.internalServices || [];
                serviceList.forEach(service => {
                    services[service] = (services[service] || 0) + 1;
                });
            });
            return Object.entries(services)
                .map(([service, count]) => ({ service, count }))
                .sort((a, b) => b.count - a.count);
        };

        // Aggregate external vendors
        const aggregateVendors = (incidents) => {
            const vendors = {};
            incidents.forEach(incident => {
                const vendorList = incident.externalVendors || [];
                vendorList.forEach(vendor => {
                    vendors[vendor] = (vendors[vendor] || 0) + 1;
                });
            });
            return Object.entries(vendors)
                .map(([vendor, count]) => ({ vendor, count }))
                .sort((a, b) => b.count - a.count);
        };

        // Build dependency matrix
        const buildDependencyMatrix = (incidents) => {
            const matrix = {};
            const allServices = new Set();
            const allVendors = new Set();

            incidents.forEach(incident => {
                // Combine affectedComponents (delivery, publishing) with internalServices
                const affectedComponents = incident.affectedComponents || [];
                const internalServices = incident.internalServices || [];
                const services = [...affectedComponents, ...internalServices];
                const vendors = incident.externalVendors || [];

                services.forEach(s => allServices.add(s));
                vendors.forEach(v => allVendors.add(v));

                // Track co-occurrence
                if (services.length > 0 && vendors.length > 0) {
                    services.forEach(service => {
                        vendors.forEach(vendor => {
                            const key = `${service}:${vendor}`;
                            matrix[key] = (matrix[key] || 0) + 1;
                        });
                    });
                }
            });

            // Sort services with delivery and publishing first
            const servicesList = Array.from(allServices);
            const sortedServices = [];

            // Add delivery first if it exists
            if (servicesList.includes('delivery')) {
                sortedServices.push('delivery');
            }
            // Add publishing second if it exists
            if (servicesList.includes('publishing')) {
                sortedServices.push('publishing');
            }
            // Add remaining services alphabetically
            servicesList
                .filter(s => s !== 'delivery' && s !== 'publishing')
                .sort()
                .forEach(s => sortedServices.push(s));

            return {
                matrix,
                services: sortedServices,
                vendors: Array.from(allVendors).sort()
            };
        };

        // Calculate key metrics
        const calculateMetrics = (incidents, services, vendors) => {
            const topVendor = vendors.length > 0 ? vendors[0] : null;
            const topService = services.length > 0 ? services[0] : null;

            let mixedCount = 0;
            incidents.forEach(incident => {
                const hasService = incident.internalServices && incident.internalServices.length > 0;
                const hasVendor = incident.externalVendors && incident.externalVendors.length > 0;
                if (hasService && hasVendor) mixedCount++;
            });

            const mixedPercent = ((mixedCount / incidents.length) * 100).toFixed(1);

            return {
                total: incidents.length,
                topVendor,
                topService,
                mixedPercent
            };
        };

        // Render key metrics
        const renderMetrics = (metrics) => {
            const container = document.getElementById('key-metrics');
            const cards = [
                { value: metrics.total, label: 'Total Incidents Analyzed' },
                {
                    value: metrics.topVendor ? `${metrics.topVendor.vendor}` : 'N/A',
                    label: metrics.topVendor ? `Top Vendor (${metrics.topVendor.count} incidents)` : 'Top Vendor'
                },
                {
                    value: metrics.topService ? `${metrics.topService.service}` : 'N/A',
                    label: metrics.topService ? `Top Service (${metrics.topService.count} incidents)` : 'Top Service'
                },
                { value: `${metrics.mixedPercent}%`, label: 'Mixed Internal/External Causes' }
            ];

            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                `;
                container.appendChild(div);
            });
        };

        // Render pie chart
        const renderPieChart = (causes) => {
            const svg = document.getElementById('pie-chart');
            const total = causes.reduce((sum, c) => sum + c.count, 0);
            const centerX = 200;
            const centerY = 200;
            const radius = 150;

            let currentAngle = -90; // Start from top

            causes.forEach((causeData) => {
                const { cause, count } = causeData;
                const angle = (count / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                // Convert to radians
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;

                // Calculate arc path
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);

                const largeArc = angle > 180 ? 1 : 0;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', CAUSE_COLORS[cause] || '#cccccc');
                path.classList.add('pie-slice');
                path.dataset.cause = cause;
                path.dataset.count = count;
                path.dataset.percent = ((count / total) * 100).toFixed(1);

                // Tooltip
                path.addEventListener('mouseenter', (e) => {
                    const tooltip = document.getElementById('tooltip');
                    tooltip.innerHTML = `
                        <strong>${CAUSE_LABELS[cause] || cause}</strong><br>
                        Incidents: ${count}<br>
                        Percentage: ${e.target.dataset.percent}%
                    `;
                    tooltip.classList.add('visible');
                });

                path.addEventListener('mousemove', (e) => {
                    const tooltip = document.getElementById('tooltip');
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY + 15) + 'px';
                });

                path.addEventListener('mouseleave', () => {
                    const tooltip = document.getElementById('tooltip');
                    tooltip.classList.remove('visible');
                });

                svg.appendChild(path);
                currentAngle = endAngle;
            });
        };

        // Render cause legend
        const renderCauseLegend = (causes) => {
            const container = document.getElementById('cause-legend');
            const total = causes.reduce((sum, c) => sum + c.count, 0);

            causes.forEach(({ cause, count }) => {
                const percent = ((count / total) * 100).toFixed(1);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${CAUSE_COLORS[cause] || '#ccc'}"></div>
                    <div class="legend-label">${CAUSE_LABELS[cause] || cause}</div>
                    <div class="legend-value">${count} (${percent}%)</div>
                `;
                container.appendChild(item);
            });
        };

        // Render bar chart
        const renderBarChart = (data, containerId, isVendor = false) => {
            const container = document.getElementById(containerId);

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No data available</div>';
                return;
            }

            const max = Math.max(...data.map(d => d.count));

            data.forEach(item => {
                const label = item.service || item.vendor;
                const count = item.count;
                const percent = (count / max) * 100;

                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${label}</div>
                    <div class="bar-visual">
                        <div class="bar-fill ${isVendor ? 'vendor' : ''}" style="width: ${percent}%">
                            ${count}
                        </div>
                    </div>
                `;
                container.appendChild(barItem);
            });
        };

        // Render dependency matrix
        const renderMatrix = (matrixData) => {
            const container = document.getElementById('matrix-container');
            const { matrix, services, vendors } = matrixData;

            if (services.length === 0 || vendors.length === 0) {
                container.innerHTML = '<div class="empty-state">No dependency data available</div>';
                return;
            }

            const matrixEl = document.createElement('div');
            matrixEl.className = 'matrix';

            // Find max for color scaling
            const maxValue = Math.max(...Object.values(matrix));

            // Header row
            const headerRow = document.createElement('div');
            headerRow.className = 'matrix-row';

            const cornerCell = document.createElement('div');
            cornerCell.className = 'matrix-cell header';
            headerRow.appendChild(cornerCell);

            vendors.forEach(vendor => {
                const cell = document.createElement('div');
                cell.className = 'matrix-cell header';
                cell.textContent = vendor;
                headerRow.appendChild(cell);
            });

            matrixEl.appendChild(headerRow);

            // Data rows
            services.forEach(service => {
                const row = document.createElement('div');
                row.className = 'matrix-row';

                const labelCell = document.createElement('div');
                labelCell.className = 'matrix-cell row-label';
                labelCell.textContent = service;
                row.appendChild(labelCell);

                vendors.forEach(vendor => {
                    const key = `${service}:${vendor}`;
                    const count = matrix[key] || 0;
                    const level = count === 0 ? 0 : Math.min(Math.ceil((count / maxValue) * 10), 10);

                    const cell = document.createElement('div');
                    cell.className = `matrix-cell data level-${level}`;
                    cell.textContent = count || '-';
                    cell.dataset.service = service;
                    cell.dataset.vendor = vendor;
                    cell.dataset.count = count;

                    if (count > 0) {
                        cell.addEventListener('mouseenter', (e) => {
                            const tooltip = document.getElementById('tooltip');
                            tooltip.innerHTML = `
                                <strong>${service} + ${vendor}</strong><br>
                                Co-occurred in ${count} incident${count !== 1 ? 's' : ''}
                            `;
                            tooltip.classList.add('visible');
                        });

                        cell.addEventListener('mousemove', (e) => {
                            const tooltip = document.getElementById('tooltip');
                            tooltip.style.left = (e.clientX + 15) + 'px';
                            tooltip.style.top = (e.clientY + 15) + 'px';
                        });

                        cell.addEventListener('mouseleave', () => {
                            const tooltip = document.getElementById('tooltip');
                            tooltip.classList.remove('visible');
                        });
                    }

                    row.appendChild(cell);
                });

                matrixEl.appendChild(row);
            });

            container.appendChild(matrixEl);
        };

        // Initialize
        const init = async () => {
            const incidents = await getIncidents();

            // Aggregate data
            const causes = aggregateRootCauses(incidents);
            const services = aggregateServices(incidents);
            const vendors = aggregateVendors(incidents);
            const matrixData = buildDependencyMatrix(incidents);
            const metrics = calculateMetrics(incidents, services, vendors);

            // Render all visualizations
            renderMetrics(metrics);
            renderPieChart(causes);
            renderCauseLegend(causes);
            renderBarChart(services, 'services-chart', false);
            renderBarChart(vendors, 'vendors-chart', true);
            renderMatrix(matrixData);

            // Set year in footer
            document.getElementById('year').textContent = new Date().getFullYear();
            document.body.classList.add('ready');
        };

        init();
    </script>
</body>
</html>
