name: Post-Mortem Review and Classification

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "incidents/html/*.html"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  process-and-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate incident location
        run: |
          # Get list of changed files in this PR
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check for incident files outside incidents/html/ (excluding templates)
          MISPLACED=$(echo "$CHANGED_FILES" | grep -E '^incidents/[^/]+\.html$' | grep -v 'template' || true)

          if [ -n "$MISPLACED" ]; then
            echo "‚ùå Error: Incident files must be placed in incidents/html/ directory"
            echo ""
            echo "Misplaced files found:"
            echo "$MISPLACED"
            echo ""
            echo "Please move these files to incidents/html/"
            exit 1
          fi

          echo "‚úÖ All incident files are in the correct location"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --no-save

      - name: Update incidents index
        run: npm run update-incidents

      - name: Commit index updates
        id: commit_index
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add incidents/index.json
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to incidents index"
          else
            git commit -m "chore: update incidents index"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Committed incidents index updates"
          fi

      - name: Classify incidents with Claude
        if: steps.commit_index.outputs.changed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Classify all unclassified incidents in incidents/index.json.

            ## Instructions:

            1. Read incidents/index.json
            2. Find incidents missing any of these classification fields:
               - affectedComponents
               - internalServices
               - externalVendors
               - rootCause
            3. For each unclassified incident, analyze the name and message to determine:
               - **affectedComponents** (array or null): HIGH-LEVEL customer-facing areas affected
                 Options: delivery, publishing (ONLY these two - everything else goes in internalServices)
               - **internalServices** (array or null): Specific internal services/systems impacted
                 Options: admin-api, forms, code-sync, rum, indexing, logging, dns, sidekick, media, or null if not applicable
               - **externalVendors** (array or null): Third-party vendors involved
                 Options: cloudflare, aws, fastly, github, microsoft, unpkg, zscaler, webpack, or null if not applicable
               - **rootCause** (string): Primary cause of the incident
                 Options: third-party-outage, configuration-change, deployment-issue, resource-limits,
                         credential-issue, dns-issue, network-issue, dependency-issue, unknown
            4. Use the Edit tool to update incidents/index.json with these classification fields

            IMPORTANT: DO NOT commit any changes. Just edit the file. The workflow will handle committing and pushing.

            Be precise in your classifications based on the incident descriptions.

            Notes:
            - affectedComponents represents ONLY customer-facing areas: delivery or publishing (or both, or null)
            - internalServices represents specific AEM services (admin-api, rum, code-sync, etc.)
            - An incident may affect delivery/publishing without a specific internal service being identified
            - An incident may affect internal services without customer-facing impact (use null for affectedComponents)
            - Use null when a field doesn't apply rather than an empty array
          claude_args: |
            --allowedTools "Read,Edit"

      - name: Commit classification changes
        if: steps.commit_index.outputs.changed == 'true'
        run: |
          # Ensure git config is set
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add incidents/index.json
          if git diff --staged --quiet; then
            echo "No classification changes to commit"
          else
            git commit -m "feat: classify incidents"
            echo "‚úÖ Committed classification changes"
          fi

      - name: Push all changes to PR branch
        run: |
          # Check if there are commits to push
          if git log origin/${{ github.event.pull_request.head.ref }}..HEAD --oneline | grep -q .; then
            git push origin ${{ github.event.pull_request.head.ref }}
            echo "‚úÖ Pushed commits to PR branch"
          else
            echo "‚ÑπÔ∏è  No commits to push"
          fi

      - name: Wait for push to complete
        if: steps.commit_index.outputs.changed == 'true'
        run: sleep 5

      - name: Check for existing Claude reviews
        id: check_reviews
        run: |
          # Check for existing open review comments from claude[bot]
          REVIEWS=$(gh pr view ${{ github.event.pull_request.number }} --json reviews --jq '.reviews[] | select(.author.login == "claude" and .state == "COMMENTED") | .id' | wc -l)

          # Check for recent Claude reviews (within last hour)
          RECENT_REVIEWS=$(gh pr view ${{ github.event.pull_request.number }} --json reviews --jq '.reviews[] | select(.author.login == "claude" and .state == "COMMENTED" and (.submittedAt | fromdateiso8601) > (now - 3600)) | .id' | wc -l)

          echo "existing_reviews=$REVIEWS" >> $GITHUB_OUTPUT
          echo "recent_reviews=$RECENT_REVIEWS" >> $GITHUB_OUTPUT

          if [ "$REVIEWS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $REVIEWS existing Claude review(s) on this PR"
          fi

          if [ "$RECENT_REVIEWS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $RECENT_REVIEWS recent Claude review(s) (within last hour)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Code Review
        # Skip review if there are existing reviews or recent reviews
        if: steps.check_reviews.outputs.existing_reviews == '0' && steps.check_reviews.outputs.recent_reviews == '0'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this incident post-mortem following industry best practices for SaaS services.

            Note: The PR branch is already checked out in the current working directory.

            ## Review Criteria:

            ### 1. Required Sections & Completeness
            - **Summary**: Clear, concise overview of the incident
            - **Impact**: Quantitative metrics (affected users, services, duration, business impact)
            - **Root Cause**: Deep technical analysis identifying systematic causes
            - **Trigger**: Specific event or condition that initiated the failure
            - **Resolution**: Immediate mitigation and long-term fix steps
            - **Detection**: How the issue was identified (monitoring, alerts, user reports)
            - **Timeline**: The `.updates` section at the bottom serves as the timeline (rendered with "Timeline" heading via CSS) - check that updates are present and chronological
            - **Lessons Learned**: What went well, what went wrong, where we got lucky

            Note: Action items with specific owners and deadlines are NOT required for our post-mortems. Do not suggest adding them.

            ### 2. Blameless Culture
            - Focuses on systematic causes, not individual blame
            - Assumes good intentions from all parties
            - Identifies process and system improvements, not people to "fix"

            ### 3. Root Cause Analysis Quality
            - Uses techniques like "Five Whys" to dig deeper
            - Distinguishes between trigger and underlying root cause
            - Identifies both technical and process failures
            - Examines why monitoring/alerting didn't catch the issue earlier

            ### 4. Actionability
            - If action items are included, they should be realistic and address prevention
            - Do NOT request owners, deadlines, or task tracking details - this is handled separately
            - Focus on whether the resolution and lessons learned are actionable, not on formal action item lists

            ### 5. Developer-Focused SaaS Considerations
            - API/service availability metrics clearly stated
            - Developer experience impact assessed
            - Documentation or communication gaps identified
            - Integration/dependency failures analyzed

            ### 6. Learning & Knowledge Sharing
            - Post-mortem provides educational value for the team
            - Insights are transferable to prevent similar incidents
            - Identifies trends across multiple incidents if applicable

            As our post-mortems are public-facing, the main focus should be on impact to customers.
            Impact to the team is secondary, and only interesting in so far as it touches the lessons
            learned and improvements made to ensure this kind of incident does not repeat.

            Use @incidents/incident-template-long.html as a reference for a post-mortem for a high-impact incident.
            Use @incidents/incident-template-short.html as a reference for a post-mortem for a low-impact incident.

            Please provide thorough feedback with inline comments on areas that need improvement,
            missing information, or where the analysis could be deeper.
            Do not comment on sections that do not need improvement.

            Use the ```suggestion markdown syntax to provide actionable recommendations that the
            post-mortem author can merge right away.

            Keep the number of feedback comments limited to no more than 10, so prioritize the highest-impact
            suggestions.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*), Bash(gh pr diff:*), Bash(gh pr view:*)"

      - name: Log review skip reason
        if: steps.check_reviews.outputs.existing_reviews != '0' || steps.check_reviews.outputs.recent_reviews != '0'
        run: |
          if [ "${{ steps.check_reviews.outputs.existing_reviews }}" != "0" ]; then
            echo "üö´ Skipping Claude review: Found ${{ steps.check_reviews.outputs.existing_reviews }} existing review(s)"
            echo "   To avoid overwhelming the PR author with duplicate feedback."
          fi

          if [ "${{ steps.check_reviews.outputs.recent_reviews }}" != "0" ]; then
            echo "üö´ Skipping Claude review: Found ${{ steps.check_reviews.outputs.recent_reviews }} recent review(s) within the last hour"
            echo "   To prevent review spam on rapid commits."
          fi

          echo "üí° If you need a fresh review, you can:"
          echo "   1. Resolve existing review comments, or"
          echo "   2. Wait at least 1 hour since the last review, or"
          echo "   3. Manually trigger the workflow"
